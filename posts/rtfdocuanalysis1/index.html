<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>RTF doc analysis | rgxsec @ caravela</title>
<meta name=keywords content><meta name=description content="An attempt to lay path for rtf document analysis - Part 1
Lore size xs
Don&rsquo;t be fooled by its name, the text in Rich Text Format (RTF) documents isn&rsquo;t gold plated or bathed in some kind of rare mineral pool (I know. lame ass joke &ndash; get used to it). The purpose of its origin was to serve as a cross-platform text format between Macintosh and Windows systems, and was developed by Microsoft in 1987."><meta name=author content="rgxec"><link rel=canonical href=https://rgxsec.github.io/posts/rtfdocuanalysis1/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://rgxsec.github.io/images/my3iconpic.png><link rel=icon type=image/png sizes=16x16 href=https://rgxsec.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rgxsec.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://rgxsec.github.io/apple-touch-icon.png><link rel=mask-icon href=https://rgxsec.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://rgxsec.github.io/posts/rtfdocuanalysis1/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://rgxsec.github.io/posts/rtfdocuanalysis1/"><meta property="og:site_name" content="rgxsec @ caravela"><meta property="og:title" content="RTF doc analysis"><meta property="og:description" content="An attempt to lay path for rtf document analysis - Part 1
Lore size xs Don’t be fooled by its name, the text in Rich Text Format (RTF) documents isn’t gold plated or bathed in some kind of rare mineral pool (I know. lame ass joke – get used to it). The purpose of its origin was to serve as a cross-platform text format between Macintosh and Windows systems, and was developed by Microsoft in 1987."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-10-30T08:30:39+00:00"><meta property="article:modified_time" content="2025-10-30T08:30:39+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="RTF doc analysis"><meta name=twitter:description content="An attempt to lay path for rtf document analysis - Part 1
Lore size xs
Don&rsquo;t be fooled by its name, the text in Rich Text Format (RTF) documents isn&rsquo;t gold plated or bathed in some kind of rare mineral pool (I know. lame ass joke &ndash; get used to it). The purpose of its origin was to serve as a cross-platform text format between Macintosh and Windows systems, and was developed by Microsoft in 1987."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://rgxsec.github.io/posts/"},{"@type":"ListItem","position":2,"name":"RTF doc analysis","item":"https://rgxsec.github.io/posts/rtfdocuanalysis1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"RTF doc analysis","name":"RTF doc analysis","description":"An attempt to lay path for rtf document analysis - Part 1\nLore size xs Don\u0026rsquo;t be fooled by its name, the text in Rich Text Format (RTF) documents isn\u0026rsquo;t gold plated or bathed in some kind of rare mineral pool (I know. lame ass joke \u0026ndash; get used to it). The purpose of its origin was to serve as a cross-platform text format between Macintosh and Windows systems, and was developed by Microsoft in 1987.\n","keywords":[],"articleBody":"An attempt to lay path for rtf document analysis - Part 1\nLore size xs Don’t be fooled by its name, the text in Rich Text Format (RTF) documents isn’t gold plated or bathed in some kind of rare mineral pool (I know. lame ass joke – get used to it). The purpose of its origin was to serve as a cross-platform text format between Macintosh and Windows systems, and was developed by Microsoft in 1987.\nI think the rich part comes from the fact that RTF isn’t just a text document, it uses plain-text markup language commands, to embed objects (smirk) and to instruct applications (yes, multiple) on how data should be displayed, among few other things.\nIf you would like to know more about its Rich ;) history, check Understanding Rich Text Format: What Exactly Is RTF Anyway?\nOld but still kinda gold From a digital security standpoint, the RTF document is very much relevant today, because of its embed object capabilities, application adaptability, Windows version acceptance and can execute on preview pane in some situations. Although RTF docs do not support macros, Threat Actors (TAs) can still embed OLE/OLE2 objects, that have macro capabilities, or just plain shellcode embedded in the RTF object stream to exploit a known application vulnerability, as is with the Word Equation Editor Unit 42 - Palo Alto example.\nThey can take advantage of OLE2 objects as containers, with the Compound Binary Format (CBF), to smuggle executables, scripts and others. Also they can use the \\pict control word to embed a image in a steganography combo.\nNote: When the RTF file is being created, along with the embedded package malicious OLE file, for example a payload, Microsoft Word automatically copies the object to the C:\\Users\\USER\\AppData\\Local\\Temp\\ path. If the TA for some reason tests the weaponized file and clicks the packaged object, the Temp path in the rtfobj tool output will come as C:\\Users\\USER\\AppData\\Local\\Temp\\ plus the GUID directories such as {4DA57CAD-DF80-4CA2-A630-BCB11819DF7D}{CC9BDCD4-9537-47A5-961D-E22EA828CE51} and the payload inside those, otherwise the Temp path will come simply as C:\\Users\\USER\\AppData\\Local\\Temp\\payload.\nThere are some awesome visuals from Ange Albertini aka corkami which can show us the doc structure of RTF docs:\nThe RTF doc is composed of Control Words and Groups. Control words start with \\ char, and Groups are delimited by { }. Groups can be nested and contain one or more control words. Groups also contain data and specifications on how that data should be formatted and displayed. Sometimes you will see a \\result control word, this is where the specification of how the data of the object should be diplayed, the data of the object will be located after the \\objdata and before the \\result.\nExample: \\object is the control word which indicate the start of an embedded object\nThe objects inside the RTF can be Linked file, which consists of a remote file, not stored within the RTF, using URL; And they can be Embedded file which is raw binary data stored directly within the RTF and inside \\object; and finally they can also contain Macintosh Edition Manager subscriber objects.\nNote: \\object and \\pict are by default embedded as hexadecimal values\nWeaponized Techniques There are several weaponizing techniques for RTF documents. On the blog, I will try to talk about the most common ones and which require the least, they will be the likely go to choices of a TA.\nEmbedded OLE Objects Equation Editor exploits ActiveX embedding Remote template injection\\OLE linking Malformed control words and images Analysis Tools rtfobj (Philippe Lagadec) rtfdump (Didier Stevens) Sample for later in the post\nMalwareBazaar\nSHA256:\n866a9be2f90b18f54c623063b0c533804aa0eb1217e334b2cb033348422ecdf5\nEmbedded OLE Objects Malicious OLE Package\nThe actions observed on this technique are based on using the RTF document as a container to embed any arbitrary file (exe, dll, hta, msi, etc..) so that when the object is triggered Windows OS runs it.\nThere are variations of these, TAs can simply embed the files without tweaks, and they can also edit the metadata of the files for social engineering purposes, make the icon more pleasing to the naive double click. The only technical difference in both is how the payload is presented to the victim.\nHere the rtfobj output of a weaponized Malicious (not very malicious just test) OLE Package:\nSimple cat command:\nVery simple, modest payload, however it can be tweaked to look like beautiful Mole, that some user would just Whac, without second thought:\nEmbedded Office Doc\nThe difference to the previous technique is that the RTF document acts as wrapper to another entire office document (docx, xls) which then would contain other malicious payloads based on VBA, DDE, XLM, etc.., hence creating a OLE2 object.\nThe victim clicks the embedded object and Word runs it not Windows OS.\nFor demo purposes we will implant some VBA code inside an excel file that tries to run calc.exe on the system, the excel file will then be wrapped by a RTF doc.\nIf we do a simple cat command on the file, we can see the difference towards the previous variant:\nD0 CF 11 E0 A1 B1 1A E1 -\u003e is the magic number or file signature for OLE Compound File Binary Format (CFBF) or OLE2\nWe can also observe the difference in rtfobj output:\nEquation Editor exploits These exploits target a Microsoft Word feature called Equation editor, which is a built-in tool for inserting and editing mathematical equations. When parsing the RTF document via MS Word for example, MS Word observes the \\objclass Equation.3, and hands it off to EQNEDT32.EXE, where the buffer overflow vulnerability exists which results on RCE.\nClassic CVEs about it:\nCVE-2017-11882 CVE-2018-0802 CVE-2018-0798 So far, I have used test samples, in order to better demo the points in discussion, however now we will use a real in the wild sample, 866a9be2f90b18f54c623063b0c533804aa0eb1217e334b2cb033348422ecdf5, in this cases we will completely rely on the tools mentioned above. Its a pain using cat commands in combination with other tools in such big files.\nID 101 You can also use magika to ID the file that we are about to analyze. In our case the extension is .rtf however it could not always be the case. Extension is the boss. There is a insanely good talk from Philippe Lagadec on how to better identify first stage malware file formats on Hack.lu 2025, which talks about file format identification tools and its qwirks.\ntrid malsample.rtf\nfile malsample.rtf\nLet’s start with rtfobj to save all the objects from the RTF doc at once into the current directory, while displaying what it finds:\nrtfobj malsample.rtf -s all\nSo in this case, its possible to see two objects:\nThe Equation exploit A second object that appears to be a PE/DLL We can also use rtfdump to get this observations:\nrtfdump.py malsample.rtf\nWith this command above we can better observe how many nested groups there are and how many childs (c=) each groups has. We can also identify on the output two objects.\nrtfdump.py -O malsample.rtf\nrtfdump.py -O -s 1 malsample.rtf\nWith these commands you will be able to look deeper into the Equation OLE2 object:\nThere are multiple cool things you can do with rtfdump, cut specific offsets of the stream for better analysis and so on, however for this specific sample I found it more easy to work with rtfobj, or my rtfdump skills are not as good maybe. But you can check more about it in the following SANS article.\nNow, there are some friends of mine which are going to go mental for the next thing I will say, but a word of advice, use what makes you better and faster. Lets use vscode! :)\nTake a look at both objects:\nObject 1:\nObject 2:\nThe interesting thing here is that in both images we are able to see the hex string with 4 bytes 01050000 and 4 bytes 02000000 in little-endian. Looking at the OLE Object header official structure in MS Doc we can understand that this hex string marks the start of a OLE Object header.\n01050000 - OLE Version (Must be ignored as per Microsoft)\n02000000 - FormatID\nThe table in MS doc tells us the meaning of FormatID:\nThe OLE object header is another funny thing in the Microsoft world, the structure fields following FormatID are equally interesting, but I will maybe talk about it in another post.\nAfter extracting both objects using rtfobj we move on and inspect the binary extracted using xxd:\nScroll down and we something even more interesting, and we can xxd to look at it better:\nxxd -g1 -s 0x920 -l 80 .bin\nAfter the exploit successfully triggers, the second object extracted from the RTF, now confirmed to be a DLL based on the observed command execution, is loaded and executed via rundll32.exe.\nmd5sum .bin\nThe analysis of this sample is out of the scope of the post, but if it proves to be a interesting sample I will talk more about it in another post.\nAfter submission in VT, for example we can see the malicious indicators.\nIf you noticed something wrong or just interested in asking something - 0xrain@protonmail.com\nReferences: MS DOC OLE Object Header\nRTF Spec\nSANS article\nRTF file structure\nUnit 42 - Palo Alto Equation editor exploit\nUnderstanding Rich Text Format: What Exactly Is RTF Anyway?\n","wordCount":"1547","inLanguage":"en","datePublished":"2025-10-30T08:30:39Z","dateModified":"2025-10-30T08:30:39Z","author":{"@type":"Person","name":"rgxec"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rgxsec.github.io/posts/rtfdocuanalysis1/"},"publisher":{"@type":"Organization","name":"rgxsec @ caravela","logo":{"@type":"ImageObject","url":"https://rgxsec.github.io/images/my3iconpic.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://rgxsec.github.io/ accesskey=h title="rgxsec @ caravela (Alt + H)">rgxsec @ caravela</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://rgxsec.github.io/posts title=Posts><span>Posts</span></a></li><li><a href=https://rgxsec.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://rgxsec.github.io/about title="About me"><span>About me</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://rgxsec.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://rgxsec.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">RTF doc analysis</h1><div class=post-meta><span title='2025-10-30 08:30:39 +0000 UTC'>2025-10-30</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;rgxec</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#lore-size-xs aria-label="Lore size xs">Lore size xs</a></li><li><a href=#old-but-still-kinda-gold aria-label="Old but still kinda gold">Old but still kinda gold</a></li><li><a href=#weaponized-techniques aria-label="Weaponized Techniques">Weaponized Techniques</a></li><li><a href=#analysis aria-label=Analysis>Analysis</a><ul><li><a href=#tools aria-label=Tools>Tools</a></li><li><a href=#sample aria-label=Sample>Sample</a></li></ul></li><li><a href=#embedded-ole-objects aria-label="Embedded OLE Objects">Embedded OLE Objects</a></li><li><a href=#equation-editor-exploits aria-label="Equation Editor exploits">Equation Editor exploits</a><ul><li><a href=#id-101 aria-label="ID 101">ID 101</a></li></ul></li><li><a href=#references aria-label=References:>References:</a></li></ul></div></details></div><div class=post-content><p><em>An attempt to lay path for rtf document analysis - Part 1</em></p><h3 id=lore-size-xs>Lore size xs<a hidden class=anchor aria-hidden=true href=#lore-size-xs>#</a></h3><p>Don&rsquo;t be fooled by its name, the text in Rich Text Format (RTF) documents isn&rsquo;t gold plated or bathed in some kind of rare mineral pool (I know. lame ass joke &ndash; get used to it). The purpose of its origin was to serve as a cross-platform text format between Macintosh and Windows systems, and was developed by Microsoft in 1987.</p><p>I think the <strong>rich</strong> part comes from the fact that RTF isn&rsquo;t just a text document, it uses plain-text markup language commands, to embed objects (smirk) and to instruct applications (yes, multiple) on how data should be displayed, among few other things.</p><p>If you would like to know more about its Rich ;) history, check <a href=https://iscanner.com/understanding-rich-text-format-what-exactly-is-rtf-anyway/><em>Understanding Rich Text Format: What Exactly Is RTF Anyway?</em></a></p><hr><h3 id=old-but-still-kinda-gold>Old but still kinda gold<a hidden class=anchor aria-hidden=true href=#old-but-still-kinda-gold>#</a></h3><p>From a digital security standpoint, the RTF document is very much relevant today, because of its embed object capabilities, application adaptability, Windows version acceptance and can execute on preview pane in some situations. Although RTF docs do not support macros, Threat Actors (TAs) can still embed OLE/OLE2 objects, that have macro capabilities, or just plain shellcode embedded in the RTF object stream to exploit a known application vulnerability, as is with the Word Equation Editor <a href=https://unit42.paloaltonetworks.com/unit42-analysis-of-cve-2017-11882-exploit-in-the-wild/><em>Unit 42 - Palo Alto example</em></a>.</p><p>They can take advantage of <strong>OLE2</strong> objects as <strong>containers</strong>, with the Compound Binary Format (CBF), to smuggle executables, scripts and others. Also they can use the <strong>\pict</strong> control word to embed a image in a steganography combo.</p><blockquote><p><strong>Note:</strong> When the RTF file is being created, along with the embedded package malicious OLE file, for example a <em>payload</em>, Microsoft Word automatically copies the object to the <em>C:\Users\USER\AppData\Local\Temp\</em> path. If the TA for some reason tests the weaponized file and clicks the packaged object, the <strong>Temp path</strong> in the <strong>rtfobj</strong> tool output will come as <em>C:\Users\USER\AppData\Local\Temp\</em> plus the GUID directories such as <strong>{4DA57CAD-DF80-4CA2-A630-BCB11819DF7D}{CC9BDCD4-9537-47A5-961D-E22EA828CE51}</strong> and the payload inside those, otherwise the <strong>Temp path</strong> will come simply as <em>C:\Users\USER\AppData\Local\Temp\payload</em>.</p></blockquote><p>There are some awesome visuals from <strong><em>Ange Albertini aka corkami</em></strong> which can show us the doc structure of RTF docs:</p><p><img alt="RTF file structure" loading=lazy src=https://raw.githubusercontent.com/corkami/pics/master/binary/rtf.png></p><p>The <strong>RTF doc</strong> is composed of <strong>Control Words</strong> and <strong>Groups</strong>. Control words start with <strong>\</strong> char, and Groups are delimited by <strong>{ }</strong>. Groups can be nested and contain one or more control words. <strong>Groups</strong> also contain data and specifications on how that data should be formatted and displayed. Sometimes you will see a <strong>\result</strong> control word, this is where the specification of how the data of the object should be diplayed, the data of the object will be located after the <strong>\objdata</strong> and before the <strong>\result</strong>.</p><blockquote><p><span style=color:red>Example:</span>
<strong>\object</strong> is the control word which indicate the start of an <strong>embedded object</strong></p></blockquote><p>The <strong>objects</strong> inside the RTF can be <strong>Linked file</strong>, which consists of a remote file, not stored within the RTF, using URL; And they can be <strong>Embedded file</strong> which is raw binary data stored directly within the RTF and inside <strong>\object</strong>; and finally they can also contain <strong>Macintosh Edition Manager subscriber objects</strong>.</p><blockquote><p><strong>Note:</strong> <strong>\object</strong> and <strong>\pict</strong> are by default embedded as hexadecimal values</p></blockquote><hr><h3 id=weaponized-techniques>Weaponized Techniques<a hidden class=anchor aria-hidden=true href=#weaponized-techniques>#</a></h3><p>There are several weaponizing techniques for RTF documents. On the blog, I will try to talk about the most common ones and which require the least, they will be the likely go to choices of a TA.</p><ul><li>Embedded OLE Objects</li><li>Equation Editor exploits</li><li>ActiveX embedding</li><li>Remote template injection\OLE linking</li><li>Malformed control words and images</li></ul><h3 id=analysis>Analysis<a hidden class=anchor aria-hidden=true href=#analysis>#</a></h3><h4 id=tools>Tools<a hidden class=anchor aria-hidden=true href=#tools>#</a></h4><ul><li>rtfobj (<em>Philippe Lagadec</em>)</li><li>rtfdump (<em>Didier Stevens</em>)</li></ul><h4 id=sample>Sample<a hidden class=anchor aria-hidden=true href=#sample>#</a></h4><p><em>for later in the post</em></p><p><a href="https://bazaar.abuse.ch/browse.php?search=md5%3A9dfeb7a4c8dee8b7c2977a8b936946b2">MalwareBazaar</a></p><p><strong>SHA256:</strong></p><blockquote><p>866a9be2f90b18f54c623063b0c533804aa0eb1217e334b2cb033348422ecdf5</p></blockquote><hr><h3 id=embedded-ole-objects>Embedded OLE Objects<a hidden class=anchor aria-hidden=true href=#embedded-ole-objects>#</a></h3><p><span style=color:#007acc>Malicious OLE Package</span></p><p>The actions observed on this technique are based on using the RTF document as a container to embed any arbitrary file (exe, dll, hta, msi, etc..) so that when the object is triggered <strong>Windows OS runs it</strong>.</p><p>There are variations of these, TAs can simply embed the files without tweaks, and they can also edit the metadata of the files for social engineering purposes, make the icon more pleasing to the naive double click. The only technical difference in both is how the payload is presented to the victim.</p><p>Here the <strong>rtfobj</strong> output of a weaponized <strong>Malicious (not very malicious just test) OLE Package</strong>:</p><p><img alt=rtfobjoutput1 loading=lazy src=/posts/rtfdocuanalysis1/rtfobjoutput1.png></p><p>Simple cat command:</p><p><img alt=cattestsample loading=lazy src=/posts/rtfdocuanalysis1/cattestsample.png></p><p>Very simple, modest payload, however it can be tweaked to look like beautiful Mole, that some user would just Whac, without second thought:</p><p><img alt=simplertf loading=lazy src=/posts/rtfdocuanalysis1/simplertf.png></p><p><span style=color:#007acc>Embedded Office Doc</span></p><p>The difference to the previous technique is that the RTF document acts as wrapper to another entire office document (docx, xls) which then would contain other malicious payloads based on <strong>VBA, DDE, XLM, etc..</strong>, hence creating a <strong>OLE2 object</strong>.</p><p>The victim clicks the embedded object and <strong>Word runs it</strong> not <strong>Windows OS</strong>.</p><p>For demo purposes we will implant some VBA code inside an excel file that tries to run <em>calc.exe</em> on the system, the excel file will then be wrapped by a RTF doc.</p><p>If we do a simple <em>cat</em> command on the file, we can see the difference towards the previous variant:</p><p><img alt=catembeddedofficefile loading=lazy src=/posts/rtfdocuanalysis1/catembeddedofficefile.png></p><blockquote><p>D0 CF 11 E0 A1 B1 1A E1 -> is the magic number or file signature for OLE Compound File Binary Format (CFBF) or OLE2</p></blockquote><p>We can also observe the difference in <strong>rtfobj</strong> output:</p><p><img alt=embeddedrtfobj loading=lazy src=/posts/rtfdocuanalysis1/embeddedrtfobj.png></p><hr><h3 id=equation-editor-exploits>Equation Editor exploits<a hidden class=anchor aria-hidden=true href=#equation-editor-exploits>#</a></h3><p>These exploits target a Microsoft Word feature called Equation editor, which is a built-in tool for inserting and editing mathematical equations. When parsing the RTF document via MS Word for example, MS Word observes the <strong>\objclass Equation.3</strong>, and hands it off to <strong>EQNEDT32.EXE</strong>, where the buffer overflow vulnerability exists which results on RCE.</p><p>Classic CVEs about it:</p><ul><li>CVE-2017-11882</li><li>CVE-2018-0802</li><li>CVE-2018-0798</li></ul><p>So far, I have used test samples, in order to better demo the points in discussion, however now we will use a real in the wild sample, <em>866a9be2f90b18f54c623063b0c533804aa0eb1217e334b2cb033348422ecdf5</em>, in this cases we will completely rely on the tools mentioned above. Its a pain using <em>cat</em> commands in combination with other tools in such big files.</p><h4 id=id-101>ID 101<a hidden class=anchor aria-hidden=true href=#id-101>#</a></h4><p>You can also use <em>magika</em> to ID the file that we are about to analyze. In our case the extension is <em>.rtf</em> however it could not always be the case. <strong>Extension is the boss</strong>. There is a insanely good talk from <em>Philippe Lagadec</em> on how to better identify first stage malware file formats on <a href="https://www.youtube.com/watch?v=Qp5GDh2sj6A"><em>Hack.lu 2025</em></a>, which talks about file format identification tools and its qwirks.</p><blockquote><p>trid malsample.rtf</p></blockquote><blockquote><p>file malsample.rtf</p></blockquote><p><img alt=idfile loading=lazy src=/posts/rtfdocuanalysis1/idfile.png></p><hr><p>Let&rsquo;s start with <strong>rtfobj</strong> to save all the objects from the RTF doc at once into the current directory, while displaying what it finds:</p><blockquote><p>rtfobj malsample.rtf -s all</p></blockquote><p><img alt=rtfobj1 loading=lazy src=/posts/rtfdocuanalysis1/rtf1.png></p><p>So in this case, its possible to see two objects:</p><ul><li>The Equation exploit</li><li>A second object that appears to be a PE/DLL</li></ul><p>We can also use <strong>rtfdump</strong> to get this observations:</p><blockquote><p>rtfdump.py malsample.rtf</p></blockquote><p>With this command above we can better observe how many nested groups there are and how many childs (c=) each groups has. We can also identify on the output two objects.</p><blockquote><p>rtfdump.py -O malsample.rtf</p></blockquote><blockquote><p>rtfdump.py -O -s 1 malsample.rtf</p></blockquote><p>With these commands you will be able to look deeper into the Equation OLE2 object:</p><p><img alt=rtfdump1 loading=lazy src=/posts/rtfdocuanalysis1/rtfdump1.png></p><p>There are multiple cool things you can do with <strong>rtfdump</strong>, cut specific offsets of the stream for better analysis and so on, however for this specific sample I found it more easy to work with <strong>rtfobj</strong>, or my <strong>rtfdump</strong> skills are not as good maybe. But you can check more about it in the following <a href=https://isc.sans.edu/diary/Malicious+RTF+Files/21315>SANS article</a>.</p><p>Now, there are some friends of mine which are going to go mental for the next thing I will say, but a word of advice, use what makes you better and faster. Lets use vscode! :)</p><p>Take a look at both objects:</p><p>Object 1:</p><p><img alt=object1 loading=lazy src=/posts/rtfdocuanalysis1/obj1.png></p><p>Object 2:</p><p><img alt=object2 loading=lazy src=/posts/rtfdocuanalysis1/object2.png></p><p>The interesting thing here is that in both images we are able to see the hex string with 4 bytes <strong>01050000</strong> and 4 bytes <strong>02000000</strong> in little-endian. Looking at the <strong>OLE Object header</strong> official structure in <a href=https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-oleds/3c695db0-943f-48a0-b134-939af3b3a4ca>MS Doc</a> we can understand that this hex string marks the start of a <strong>OLE Object header</strong>.</p><blockquote><p>01050000 - OLE Version (Must be ignored as per Microsoft)</p></blockquote><blockquote><p>02000000 - FormatID</p></blockquote><p>The table in MS doc tells us the meaning of FormatID:</p><p><img alt=msodc1 loading=lazy src=/posts/rtfdocuanalysis1/msdoc1.png></p><p>The OLE object header is another funny thing in the Microsoft world, the structure fields following FormatID are equally interesting, but I will maybe talk about it in another post.</p><p>After extracting both objects using <strong>rtfobj</strong> we move on and inspect the binary extracted using <em>xxd</em>:</p><p><img alt=eq loading=lazy src=/posts/rtfdocuanalysis1/eq1.png></p><p>Scroll down and we something even more interesting, and we can <em>xxd</em> to look at it better:</p><p><img alt=eq2 loading=lazy src=/posts/rtfdocuanalysis1/eq2.png></p><blockquote><p>xxd -g1 -s 0x920 -l 80 &lt;filename>.bin</p></blockquote><p>After the exploit successfully triggers, the second object extracted from the RTF, now confirmed to be a DLL based on the observed command execution, is loaded and executed via <strong>rundll32.exe</strong>.</p><blockquote><p>md5sum &lt;filename>.bin</p></blockquote><p>The analysis of this sample is out of the scope of the post, but if it proves to be a interesting sample I will talk more about it in another post.</p><p>After submission in VT, for example we can see the malicious indicators.</p><p><img alt=vt loading=lazy src=/posts/rtfdocuanalysis1/vt.png></p><p><em>If you noticed something wrong or just interested in asking something - 0xrain@protonmail.com</em></p><hr><h3 id=references>References:<a hidden class=anchor aria-hidden=true href=#references>#</a></h3><p><a href=https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-oleds/3c695db0-943f-48a0-b134-939af3b3a4ca>MS DOC OLE Object Header</a></p><p><a href=https://www.biblioscape.com/rtf15_spec.htm>RTF Spec</a></p><p><a href=https://isc.sans.edu/diary/Malicious+RTF+Files/21315>SANS article</a></p><p><a href=https://raw.githubusercontent.com/corkami/pics/master/binary/rtf.png>RTF file structure</a></p><p><a href=https://unit42.paloaltonetworks.com/unit42-analysis-of-cve-2017-11882-exploit-in-the-wild/>Unit 42 - Palo Alto Equation editor exploit</a></p><p><a href=https://iscanner.com/understanding-rich-text-format-what-exactly-is-rtf-anyway/>Understanding Rich Text Format: What Exactly Is RTF Anyway?</a></p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://rgxsec.github.io/posts/iaccodesecscan/><span class=title>Next »</span><br><span>IaC automated code security scanning via CI/CD pipeline - part 1</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share RTF doc analysis on x" href="https://x.com/intent/tweet/?text=RTF%20doc%20analysis&amp;url=https%3a%2f%2frgxsec.github.io%2fposts%2frtfdocuanalysis1%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share RTF doc analysis on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frgxsec.github.io%2fposts%2frtfdocuanalysis1%2f&amp;title=RTF%20doc%20analysis&amp;summary=RTF%20doc%20analysis&amp;source=https%3a%2f%2frgxsec.github.io%2fposts%2frtfdocuanalysis1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share RTF doc analysis on reddit" href="https://reddit.com/submit?url=https%3a%2f%2frgxsec.github.io%2fposts%2frtfdocuanalysis1%2f&title=RTF%20doc%20analysis"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share RTF doc analysis on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frgxsec.github.io%2fposts%2frtfdocuanalysis1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share RTF doc analysis on whatsapp" href="https://api.whatsapp.com/send?text=RTF%20doc%20analysis%20-%20https%3a%2f%2frgxsec.github.io%2fposts%2frtfdocuanalysis1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share RTF doc analysis on telegram" href="https://telegram.me/share/url?text=RTF%20doc%20analysis&amp;url=https%3a%2f%2frgxsec.github.io%2fposts%2frtfdocuanalysis1%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share RTF doc analysis on ycombinator" href="https://news.ycombinator.com/submitlink?t=RTF%20doc%20analysis&u=https%3a%2f%2frgxsec.github.io%2fposts%2frtfdocuanalysis1%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://rgxsec.github.io/>rgxsec @ caravela</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>document.addEventListener("DOMContentLoaded",function(){const e=Array.from(document.querySelectorAll(".post-content img"));e.forEach(e=>{mediumZoom(e,{margin:0,scrollOffset:40})})})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>